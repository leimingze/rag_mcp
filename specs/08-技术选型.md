# 技术选型

## RAG 核心流水线设计

### 1. 数据摄取流水线

#### 目标
构建统一、可配置、可观测的数据导入与分块能力，覆盖文档加载、格式解析、语义切分、多模态增强、嵌入计算、去重与批量上载到向量存储。

#### 技术栈
- LangChain & LangGraph

#### 设计要点
- **Loader**: 解析原始文件为统一 Document 对象（text + metadata）
- **Splitter**: 基于 Markdown 结构切分文档为 chunks
- **Transform**: 内容提取和标准化处理（Image Captioning、OCR 等）
- **Embed & Upsert**: 批量计算 embedding 并上传到向量存储
- **Dedup & Normalize**: 向量/文本去重与哈希过滤

#### 技术选型
- **PDF → Markdown**: MarkItDown（首选）
- **Splitter**: LangChain RecursiveCharacterTextSplitter
- **Vision LLM**: Azure OpenAI Vision (GPT-4o/GPT-4-Vision)
- **Vector Store**: Chroma
- **BM25**: 自建索引（基于 rank-bm25）

### 2. 检索流水线

采用多阶段过滤架构：
- **查询预处理**: 关键词提取、查询扩展（同义词/别名）
- **混合检索**: Dense（语义向量）+ Sparse（BM25）并行召回
- **融合**: RRF（Reciprocal Rank Fusion）算法
- **Reranking**: Cross-Encoder 或 LLM Rerank（可选）

### 3. MCP 服务设计

#### 核心设计理念
- 协议优先：遵循 MCP 官方规范 JSON-RPC 2.0
- 开箱即用
- 引用透明
- 多模态友好

#### 传输协议
- **stdio transport**: 零配置、隐私安全

#### SDK 选型
- Python 官方 MCP SDK（首选）

#### 核心工具

| 工具名称 | 功能描述 |
|---------|----------|
| query_knowledge_hub | 主检索入口，执行混合检索 + Rerank |
| list_collections | 列举知识库中可用的文档集合 |
| get_document_summary | 获取指定文档的摘要与元信息 |

### 4. 可插拔架构设计

#### 设计原则
- 接口隔离（Interface Segregation）
- 配置驱动（Configuration-Driven）
- 工厂模式（Factory Pattern）
- 优雅降级（Graceful Fallback）

#### 配置示例
```yaml
llm:
  provider: azure  # azure | openai | ollama | deepseek
  model: gpt-4o

embedding:
  provider: openai
  model: text-embedding-3-small

vector_store:
  backend: chroma  # chroma | qdrant | pinecone

retrieval:
  sparse_backend: bm25
  fusion_algorithm: rrf
  rerank_backend: cross_encoder  # none | cross_encoder | llm
```

### 5. 可观测性与追踪设计

#### 技术方案
- 结构化日志（JSON Lines 格式）
- 本地 Web Dashboard（Streamlit）

#### 选型理由
- 零外部依赖
- 轻量易部署
- 学习成本低
- 契合本地 MCP Server 场景

### 6. 多模态图片处理设计

#### 策略选型
采用 **Multi-Embedding** 多模态向量策略：
- 图 → 图
- 文 → 图
- 图 → 文

#### 优势
- 保留原始视觉特征，支持图搜图
- 对专利/工业图/外观设计极友好

### 7. 测试方案

#### 测试框架
- **pytest**: Python 标准测试框架
- **pytest-mock**: Mock 外部依赖
- **pytest-asyncio**: 异步测试支持

#### 测试分层
- **单元测试**: 验证单个函数/类
- **集成测试**: 验证模块协作
- **E2E 测试**: 验证完整业务流程

#### 评估框架
- **Ragas**: RAG 专用评估
- **DeepEval**: LLM-as-Judge 模式
- **自定义指标**: Hit Rate、MRR、Latency P99
